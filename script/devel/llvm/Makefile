
GARNAME      = llvm
GARVERSION   = $(LLVM_VERSION)
CATEGORIES   = devel
MASTER_SITES = https://github.com/llvm/llvm-project/releases/download/llvmorg-$(GARVERSION)/
DISTFILES    = $(DISTNAME).src.tar.xz clang-$(GARVERSION).src.tar.xz libclc-$(GARVERSION).src.tar.xz cmake-$(GARVERSION).src.tar.xz
#PATCHFILES   = fix-compile.patch
LICENSE      = $(GARNAME)
$(GARNAME)_LICENSE_TEXT = $(WORKDIR)/$(DISTNAME)/LICENSE.TXT

DESCRIPTION = 
define BLURB
endef

DEPENDS   = lang/c lang/cxx lib/libedit
BUILDDEPS = python2/python

ifneq ($(DESTIMG),build)
BUILDDEPS += devel/llvm
endif

WORKSRC = $(WORKDIR)/$(DISTNAME).src
WORKBLD = $(WORKDIR)/$(DISTNAME)_build

CONFIGURE_SCRIPTS = llvm
BUILD_SCRIPTS     = llvm llvm_config
INSTALL_SCRIPTS   = $(WORKBLD)/Makefile

CONFIGURE_ARGS = $(DIRPATHS_CMAKE) \
	-DCMAKE_VERBOSE_MAKEFILE="OFF" \
	-DLLVM_BUILD_LLVM_DYLIB="ON" \
	-DLLVM_LINK_LLVM_DYLIB="ON" \
	-DLLVM_BUILD_TOOLS="ON" \
	-DLLVM_INCLUDE_TOOLS="ON" \
	-DLLVM_BUILD_EXAMPLES="OFF" \
	-DLLVM_INCLUDE_EXAMPLES="OFF" \
	-DLLVM_BUILD_TESTS="OFF" \
	-DLLVM_INCLUDE_TESTS="OFF" \
	-DLLVM_ENABLE_LTO="OFF" \
	-DLLVM_BUILD_DOCS="OFF" \
	-DLLVM_ENABLE_DOXYGEN="OFF" \
	-DCMAKE_BUILD_TYPE=Release \
	-DLLVM_BUILD_BENCHMARKS="OFF" \
	-DLLVM_INCLUDE_BENCHMARKS="OFF" \
	-DLLVM_ENABLE_PROJECTS="clang;libclc" \
	$(if $(filter i386 x86_64,$(mm_GARCH_FAMILY)), \
	 -DLLVM_TARGET_ARCH="X86" \
	 -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU" ) \
	$(if $(filter arm,   $(mm_GARCH_FAMILY)), \
	 -DLLVM_TARGET_ARCH="ARM" \
	 -DLLVM_TARGETS_TO_BUILD="ARM" ) \
	$(if $(filter arm64, $(mm_GARCH_FAMILY)), \
	 -DLLVM_TARGET_ARCH="AArch64" \
	 -DLLVM_TARGETS_TO_BUILD="AArch64" )

GAR_EXTRA_CONF += devel/llvm/package-api.mk
include ../../gar.mk

ifneq ($(DESTIMG),build)
CONFIGURE_ARGS += \
	-DCMAKE_CROSSCOMPILING="True" \
	-DLLVM_DEFAULT_TARGET_TRIPLE="$(mm_GARHOST)" \
	-DLLVM_HOST_TRIPLE="$(mm_GARHOST)" \
	-DLLVM_NATIVE_TOOL_DIR="$(build_DESTDIR)$(build_bindir)" \
	-DLLVM_TABLEGEN="$(build_DESTDIR)$(build_bindir)/llvm-tblgen"
endif

# the configure script applies the host compiler flags when checking the build compiler.
CFLAGS   :=
CXXFLAGS :=
LDFLAGS  :=

pre-configure: 
	@mv $(WORKDIR)/$(DISTNAME).src $(WORKDIR)/$(DISTNAME)
	@cp $(WORKDIR)/cmake-$(GARVERSION).src/Modules/* $(WORKDIR)/$(DISTNAME)/cmake/modules/
	@mkdir -p $(WORKDIR)/cmake
	@mv $(WORKDIR)/cmake-$(GARVERSION).src/* $(WORKDIR)/cmake/
	@mkdir -p $(WORKDIR)/clang
	@mv $(WORKDIR)/clang-$(GARVERSION).src/* $(WORKDIR)/clang/
	@mkdir -p $(WORKDIR)/libclc
	@mv $(WORKDIR)/libclc-$(GARVERSION).src/* $(WORKDIR)/libclc/
	@$(MAKECOOKIE)

configure-llvm:
	@echo " ==> Running configure in $(WORKBLD)"
	@rm -rf $(WORKBLD)
	@mkdir -p $(WORKBLD)
	@cd $(WORKBLD) && $(CONFIGURE_ENV) $(CMAKE) $(DIRPATHS_CMAKE) $(CONFIGURE_ARGS) ../$(DISTNAME)
	@$(MAKECOOKIE)

post-configure:
	#hack to get clang cross-compiling.....
	@sed \
	 -e 's%.*<TARGET_FILE:clang-ast-dump>%        $(build_DESTDIR)$(build_bindir)/clang-ast-dump%g' \
	 -i $(WORKDIR)/clang/lib/Tooling/CMakeLists.txt
	@$(MAKECOOKIE)

build-llvm:
	@echo " ==> Running build in $(WORKBLD)"
	@cd $(WORKBLD) && $(CMAKE) --build . --parallel $(PARALLELMFLAGS)
	@$(MAKECOOKIE)

build-llvm_config:
	@$(MAKE) -C $(WORKBLD) llvm-config
	@$(MAKECOOKIE)

post-install:
	@mkdir -p $(DESTDIR)$(bindir)-config
	@$(if $(filter build, $(DESTIMG)), \
	 cp $(WORKBLD)/bin/llvm-config $(DESTDIR)$(bindir)-config/llvm-config, \
	 echo '#!/bin/sh'                      > $(DESTDIR)$(bindir)-config/llvm-config ; \
	 echo 'echo "$$@" >> llvm-config.log' >> $(DESTDIR)$(bindir)-config/llvm-config ; \
	 echo '$(build_DESTDIR)$(build_bindir)-config/llvm-config "$$@" | sed -e "s/build/main/g" >> llvm-config.log 2>&1' >> $(DESTDIR)$(bindir)-config/llvm-config ; \
	 echo '$(build_DESTDIR)$(build_bindir)-config/llvm-config "$$@" | sed -e "s/build/main/g"'                         >> $(DESTDIR)$(bindir)-config/llvm-config ; \
	 chmod +x $(DESTDIR)$(bindir)-config/llvm-config )
	@$(if $(compiler_prefix), ln -sf llvm-config $(DESTDIR)$(bindir)-config/$(compiler_prefix)llvm-config)
	@$(MAKECOOKIE)

clean-all:
	@rm -f $(DESTDIR)$(bindir)-config/llvm-config
	@rm -f $(DESTDIR)$(bindir)/llvm*
	@rm -f $(DESTDIR)$(bindir)/clang*
	@rm -f $(DESTDIR)$(libdir)/libLLVM*
	@rm -f $(DESTDIR)$(libdir)/libclang*
	@rm -rf $(DESTDIR)$(libdir)/clang*
	@rm -f $(DESTDIR)$(libdir)/LLVMHello.so
	@rm -f $(DESTDIR)$(libdir)/libLTO*
	@rm -rf $(DESTDIR)$(includedir)/llvm*
